# attribution: mostly copied from Zen

unset MOZ_STDCXX_COMPAT

ac_add_options --disable-dmd
ac_add_options --enable-eme=widevine

# override LTO settings
if test "GLIDE_LTO"; then
  export MOZ_LTO=cross,thin
  ac_add_options --enable-lto=cross,thin
else
  ac_add_options --disable-lto
fi

# TODO(glide): some combination of these options are causing bad things to happen
# export MOZ_PGO=1
# ac_add_options MOZ_PGO=1
# ac_add_options --enable-clang-plugin
# ac_add_options --target=aarch64-apple-darwin
# ac_add_options --enable-optimize="-O3 -mcpu=apple-m1 -march=armv8.3-a+simd"

# As of Clang 13, the default is -mcpu=apple-m1 when using a aarch64-apple-macos target,
# but we're using apple64-apple-darwin, which defaults to -mcpu=apple-a7, which disables
# a bunch of # performance-enabling CPU features.
export CFLAGS="-O3 -march=armv8.3-a+simd"
export CPPFLAGS="-O3 -march=armv8.3-a+simd"
export CXXFLAGS="-O3 -march=armv8.3-a+simd"
export LDFLAGS="-Wl,-O3 -march=armv8.3-a+simd"
export RUSTFLAGS="-C target-feature=+v8.3a -Ctarget-cpu=apple-m1"

export VERBOSE=1
